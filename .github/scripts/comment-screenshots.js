#!/usr/bin/env node

/**
 * Posts or updates a PR comment with embedded E2E screenshots.
 * 
 * Required environment variables:
 * - GITHUB_TOKEN: GitHub API token
 * - GITHUB_REPOSITORY: owner/repo
 * - PR_NUMBER: Pull request number
 * - PR_BRANCH: PR head branch name
 * - RUN_ID: GitHub Actions run ID
 * - TEST_OUTCOME: 'success' or 'failure'
 */

const fs = require('fs');
const path = require('path');
const https = require('https');

const {
  GITHUB_TOKEN,
  GITHUB_REPOSITORY,
  PR_NUMBER,
  PR_BRANCH,
  RUN_ID,
  TEST_OUTCOME,
} = process.env;

if (!GITHUB_TOKEN || !GITHUB_REPOSITORY || !PR_NUMBER || !PR_BRANCH || !RUN_ID) {
  console.error('Missing required environment variables');
  process.exit(1);
}

const [owner, repo] = GITHUB_REPOSITORY.split('/');
const passed = TEST_OUTCOME === 'success';
const statusEmoji = passed ? 'âœ…' : 'âŒ';
const statusText = passed ? 'passed' : 'failed';

// Find all screenshot files recursively
function findScreenshots(dir, files = []) {
  if (!fs.existsSync(dir)) return files;
  const items = fs.readdirSync(dir);
  for (const item of items) {
    const fullPath = path.join(dir, item);
    if (fs.statSync(fullPath).isDirectory()) {
      findScreenshots(fullPath, files);
    } else if (item.endsWith('.png')) {
      files.push(fullPath);
    }
  }
  return files;
}

// Make GitHub API request
function githubRequest(method, endpoint, body = null) {
  return new Promise((resolve, reject) => {
    const options = {
      hostname: 'api.github.com',
      path: endpoint,
      method,
      headers: {
        'Authorization': `token ${GITHUB_TOKEN}`,
        'User-Agent': 'e2e-screenshot-bot',
        'Accept': 'application/vnd.github.v3+json',
        'Content-Type': 'application/json',
      },
    };

    const req = https.request(options, (res) => {
      let data = '';
      res.on('data', chunk => data += chunk);
      res.on('end', () => {
        if (res.statusCode >= 200 && res.statusCode < 300) {
          resolve(JSON.parse(data || '{}'));
        } else {
          reject(new Error(`GitHub API error: ${res.statusCode} ${data}`));
        }
      });
    });

    req.on('error', reject);
    if (body) req.write(JSON.stringify(body));
    req.end();
  });
}

async function main() {
  const screenshots = findScreenshots('e2e');

  if (screenshots.length === 0) {
    console.log('No screenshots found');
    return;
  }

  console.log(`Found ${screenshots.length} screenshots`);

  // Build image URLs from the PR branch
  const rawBaseUrl = `https://raw.githubusercontent.com/${owner}/${repo}/${PR_BRANCH}`;

  // Group screenshots by test file
  const groupedScreenshots = {};
  for (const screenshot of screenshots) {
    const parts = screenshot.split('/');
    // Path like: e2e/landing.spec.ts-snapshots/landing-hero-1-chromium-linux.png
    const testFile = parts[1]?.replace('.spec.ts-snapshots', '') || 'other';
    if (!groupedScreenshots[testFile]) {
      groupedScreenshots[testFile] = [];
    }
    groupedScreenshots[testFile].push(screenshot);
  }

  // Build screenshot gallery
  let screenshotGallery = '';
  for (const [testFile, files] of Object.entries(groupedScreenshots)) {
    screenshotGallery += `\n<details>\n<summary><strong>${testFile}</strong> (${files.length} screenshots)</summary>\n\n`;
    for (const file of files) {
      const fileName = path.basename(file);
      const imageUrl = `${rawBaseUrl}/${file}`;
      screenshotGallery += `#### ${fileName}\n![${fileName}](${imageUrl})\n\n`;
    }
    screenshotGallery += `</details>\n`;
  }

  // Build comment body
  const artifactUrl = `https://github.com/${owner}/${repo}/actions/runs/${RUN_ID}`;
  const body = [
    `## ${statusEmoji} E2E Screenshot Tests ${statusText}`,
    '',
    `**${screenshots.length} screenshots** were captured during the E2E test run.`,
    '',
    screenshotGallery,
    '',
    '---',
    `ðŸ“¦ [Download all screenshots](${artifactUrl})`,
    '',
    `<sub>Generated by E2E workflow run [#${RUN_ID}](${artifactUrl}) â€¢ Last updated: ${new Date().toISOString()}</sub>`,
  ].join('\n');

  // Find existing comment
  const comments = await githubRequest('GET', `/repos/${owner}/${repo}/issues/${PR_NUMBER}/comments`);
  const existingComment = comments.find(c =>
    c.user.type === 'Bot' && c.body.includes('E2E Screenshot Tests')
  );

  if (existingComment) {
    await githubRequest('PATCH', `/repos/${owner}/${repo}/issues/comments/${existingComment.id}`, { body });
    console.log(`Updated existing comment ${existingComment.id}`);
  } else {
    await githubRequest('POST', `/repos/${owner}/${repo}/issues/${PR_NUMBER}/comments`, { body });
    console.log('Created new comment');
  }
}

main().catch(err => {
  console.error(err);
  process.exit(1);
});
